global:
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@financial-system.com'
  smtp_auth_username: 'alerts@financial-system.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Slacké…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # é»˜è®¤æ¨¡æ¿
  resolve_timeout: 5m

# æ¨¡æ¿æ–‡ä»¶
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-team'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s        # ç­‰å¾…åˆ†ç»„æ—¶é—´
  group_interval: 5m     # åˆ†ç»„å‘é€é—´éš”
  repeat_interval: 4h    # é‡å¤å‘é€é—´éš”
  
  # å­è·¯ç”±
  routes:
    # å…³é”®ä¸šåŠ¡å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 30m
      
    # åº”ç”¨å‘Šè­¦
    - match:
        component: application
      receiver: 'application-team'
      group_by: ['alertname', 'service']
      
    # æ•°æ®åº“å‘Šè­¦
    - match:
        component: database
      receiver: 'database-team'
      group_by: ['alertname', 'instance']
      
    # åŸºç¡€è®¾æ–½å‘Šè­¦
    - match:
        component: infrastructure
      receiver: 'infrastructure-team'
      group_by: ['alertname', 'instance']
      
    # Kuberneteså‘Šè­¦
    - match:
        component: kubernetes
      receiver: 'kubernetes-team'
      
    # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
    - match:
        component: business
      receiver: 'business-team'
      group_by: ['alertname']
      repeat_interval: 2h
      
    # å¤–éƒ¨æœåŠ¡å‘Šè­¦
    - match:
        component: external
      receiver: 'external-services-team'
      
    # ç›‘æ§ç³»ç»Ÿå‘Šè­¦
    - match:
        component: monitoring
      receiver: 'monitoring-team'
      
    # éå·¥ä½œæ—¶é—´å‘Šè­¦æŠ‘åˆ¶
    - match:
        severity: warning
      receiver: 'low-priority-alerts'
      active_time_intervals:
        - business_hours

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # æœåŠ¡ä¸‹çº¿æ—¶æŠ‘åˆ¶å…¶ä»–å‘Šè­¦
  - source_matchers:
      - alertname="ServiceDown"
    target_matchers:
      - component="application"
    equal: ['instance', 'job']
    
  # èŠ‚ç‚¹ä¸‹çº¿æ—¶æŠ‘åˆ¶ç›¸å…³å‘Šè­¦
  - source_matchers:
      - alertname="NodeNotReady"
    target_matchers:
      - component="infrastructure"
    equal: ['instance']
    
  # æ•°æ®åº“ä¸‹çº¿æ—¶æŠ‘åˆ¶ç›¸å…³å‘Šè­¦
  - source_matchers:
      - alertname="PostgreSQLDown"
    target_matchers:
      - component="database"
    equal: ['instance']

# æ—¶é—´é—´éš”é…ç½®
time_intervals:
  - name: business_hours
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default-team'
    email_configs:
      - to: 'devops@financial-system.com'
        subject: '[è´¢åŠ¡ç³»ç»Ÿ] {{ .GroupLabels.alertname }} - {{ .CommonLabels.severity }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          {{ end }}
        html: |
          <h2>è´¢åŠ¡ç³»ç»Ÿå‘Šè­¦é€šçŸ¥</h2>
          <table border="1" style="border-collapse: collapse;">
            <tr><th>å‘Šè­¦</th><th>æè¿°</th><th>æ—¶é—´</th><th>çŠ¶æ€</th></tr>
            {{ range .Alerts }}
            <tr>
              <td>{{ .Annotations.summary }}</td>
              <td>{{ .Annotations.description }}</td>
              <td>{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
              <td style="color: {{ if eq .Status "firing" }}red{{ else }}green{{ end }}">
                {{ .Status }}
              </td>
            </tr>
            {{ end }}
          </table>

  # å…³é”®å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: 'critical-alerts@financial-system.com'
        subject: 'ğŸš¨ [ç´§æ€¥] è´¢åŠ¡ç³»ç»Ÿå…³é”®å‘Šè­¦'
        body: |
          âš ï¸ å…³é”®å‘Šè­¦é€šçŸ¥ âš ï¸
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æœåŠ¡: {{ .Labels.job }}
          å®ä¾‹: {{ .Labels.instance }}
          {{ end }}
          
          è¯·ç«‹å³å¤„ç†æ­¤å‘Šè­¦ï¼
    slack_configs:
      - channel: '#critical-alerts'
        title: 'ğŸš¨ è´¢åŠ¡ç³»ç»Ÿå…³é”®å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦:* {{ .Annotations.summary }}
          *æè¿°:* {{ .Annotations.description }}
          *æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          *æœåŠ¡:* {{ .Labels.job }}
          *å®ä¾‹:* {{ .Labels.instance }}
          {{ end }}
        color: 'danger'
        send_resolved: true

  # åº”ç”¨å›¢é˜Ÿ
  - name: 'application-team'
    email_configs:
      - to: 'app-team@financial-system.com'
        subject: '[åº”ç”¨å‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#app-alerts'
        title: 'åº”ç”¨æœåŠ¡å‘Šè­¦'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

  # æ•°æ®åº“å›¢é˜Ÿ
  - name: 'database-team'
    email_configs:
      - to: 'dba-team@financial-system.com'
        subject: '[æ•°æ®åº“å‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#database-alerts'
        title: 'æ•°æ®åº“å‘Šè­¦'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

  # åŸºç¡€è®¾æ–½å›¢é˜Ÿ
  - name: 'infrastructure-team'
    email_configs:
      - to: 'infra-team@financial-system.com'
        subject: '[åŸºç¡€è®¾æ–½å‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#infra-alerts'
        title: 'åŸºç¡€è®¾æ–½å‘Šè­¦'

  # Kuberneteså›¢é˜Ÿ
  - name: 'kubernetes-team'
    email_configs:
      - to: 'k8s-team@financial-system.com'
        subject: '[K8Så‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#k8s-alerts'
        title: 'Kuberneteså‘Šè­¦'

  # ä¸šåŠ¡å›¢é˜Ÿ
  - name: 'business-team'
    email_configs:
      - to: 'business-team@financial-system.com'
        subject: '[ä¸šåŠ¡å‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#business-alerts'
        title: 'ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *ä¸šåŠ¡å‘Šè­¦:* {{ .Annotations.summary }}
          *æè¿°:* {{ .Annotations.description }}
          *å½±å“:* å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡è¿è¥
          {{ end }}

  # å¤–éƒ¨æœåŠ¡å›¢é˜Ÿ
  - name: 'external-services-team'
    email_configs:
      - to: 'external-team@financial-system.com'
        subject: '[å¤–éƒ¨æœåŠ¡å‘Šè­¦] {{ .CommonLabels.alertname }}'
    slack_configs:
      - channel: '#external-alerts'
        title: 'å¤–éƒ¨æœåŠ¡å‘Šè­¦'

  # ç›‘æ§å›¢é˜Ÿ
  - name: 'monitoring-team'
    email_configs:
      - to: 'monitoring-team@financial-system.com'
        subject: '[ç›‘æ§ç³»ç»Ÿå‘Šè­¦] {{ .CommonLabels.alertname }}'

  # ä½ä¼˜å…ˆçº§å‘Šè­¦
  - name: 'low-priority-alerts'
    email_configs:
      - to: 'low-priority@financial-system.com'
        subject: '[ä½ä¼˜å…ˆçº§] {{ .CommonLabels.alertname }}'
        # åªåœ¨å·¥ä½œæ—¶é—´å‘é€
        send_resolved: false

# Webhookæ¥æ”¶è€…ï¼ˆå¯é€‰ï¼‰
  - name: 'webhook-alerts'
    webhook_configs:
      - url: 'https://api.financial-system.com/webhooks/alerts'
        send_resolved: true
        http_config:
          bearer_token: '${WEBHOOK_TOKEN}'
        max_alerts: 10